## Диаграмма системного контекста

На диаграмме системного контекста показана внутрикорпоративная система `Corporate Merch Store`, предназначенная для заказа мерча сотрудниками компании за внутренние поинты с самовывозом.

Выделены следующие роли:

- `Buyer` — сотрудник-покупатель мерча.  
- `Content Admin` — управляет каталогом, категориями и медиа.  
- `Fulfillment Admin` — обрабатывает заказы и статусы выдачи.  
- `Combo Admin` — совмещает права контент-админа и админа выдачи.  
- `Super Admin` — управляет пользователями, ролями и настройками системы.  
- `BI Analyst` — работает с аналитическими отчётами по мерчу.

Все пользовательские роли, кроме BI-аналитика, взаимодействуют с системой `Corporate Merch Store` через веб-интерфейс по HTTPS.

Также показан внешний аналитический контур: данные о заказах, остатках, леджере поинтов и отзывах ежедневно выгружаются в `Google Sheets`, затем попадают в `Google BigQuery` и используются в `Looker Studio` для построения дашбордов, с которыми работает `BI Analyst`.

Дополнительно отражены инфраструктурные внешние сервисы: `Sentry` (мониторинг ошибок), `CI/CD Pipeline` (деплой новых версий приложений) и `Backup Storage` (резервное копирование данных).

![C4_Context](../assets/c4_context/C4_Context.svg)

## Диаграмма контейнеров

Диаграмма контейнеров показывает разбиение системы `Corporate Merch Store` на исполняемые части (контейнеры) и их связи.

Внутри системы выделены:

- **Web App** — единое SPA на React/TypeScript: интерфейс покупателя (каталог, корзина, заказы, отзывы) и админ-панель (пользователи, остатки, аудит).  
- **Backend API** — модульный монолит на FastAPI (Python), реализующий бизнес-логику и REST API.  
- **Export Worker** — фоновые задачи на Python для экспорта данных в `Google Sheets` и авто-закрытия заказов.  
- **Relational Database (PostgreSQL)** — основное хранилище бизнес-данных.  
- **Cache and Jobs (Redis)** — кэш, сессии и очередь фоновых задач.  
- **File Storage (S3-compatible + CDN)** — хранилище изображений и статических файлов (внутренняя инфраструктура системы).

Внешние сервисы:

- **Google Sheets / BigQuery / Looker Studio** — цепочка для аналитики и дашбордов.  
- **Sentry** — мониторинг ошибок.  
- **CI/CD Pipeline** — автоматический деплой фронтенда и бэкенда.  
- **Backup Storage** — резервные копии базы данных.

Основные взаимодействия:

- `Buyer` и администраторы используют `Web App` по HTTPS; роль определяет доступные разделы интерфейса.  
- `Web App` обращается к `Backend API` по REST/JSON через HTTPS.  
- `Backend API` читает/пишет данные в `PostgreSQL`, использует `Redis` (кэш, сессии, постановка задач) и `File Storage` (медиа).  
- `Export Worker` получает задания из `Redis`, читает данные из `PostgreSQL` и выгружает их в `Google Sheets`.  
- Аналитика строится поверх связки `Google Sheets → BigQuery → Looker Studio`.  
- `Sentry`, `CI/CD Pipeline` и `Backup Storage` обеспечивают мониторинг, деплой и отказоустойчивость.

### Обоснование архитектурного стиля

Используется архитектура *клиент–сервер*:

- клиент: `Web App` (единое SPA на React/TypeScript с разделением сценариев по ролям);  
- сервер приложений: `Backend API` на FastAPI как модульный монолит с доменными модулями (`auth`, `users_roles`, `catalog`, `inventory`, `orders`, `ledger`, `reviews`, `imports`, `exports`, `audit`);  
- инфраструктура: `PostgreSQL`, `Redis`, S3-совместимое файловое хранилище.

Такое разбиение упрощает разработку и сопровождение внутрикорпоративной системы и при необходимости позволяет в будущем выделять отдельные домены в самостоятельные сервисы.

![C4_Containers](../assets/c4_containers/C4_Containers.svg)

## Диаграмма компонентов

В работе используются две диаграммы компонентов:

1. Для контейнера **Backend API**
2. Для контейнера **Web App**

### Компоненты Backend API

Диаграмма компонентов `Backend API` показывает декомпозицию серверного приложения на ключевые компоненты:

**Входной компонент:**

- **HTTP API (routers)** — REST/JSON API: каталог, заказы, профиль, админские операции.

**Доменные модули:**

- **Auth module** — авторизация, профиль, роли и права доступа.  
- **Users & Roles module** — управление пользователями, ролями и настройками доступа.  
- **Catalog module** — каталог товаров, категории, карточки товара и медиа.  
- **Inventory module** — остатки, корректировки и импорт остатков.  
- **Orders module** — корзина/оформление заказа, статусы, отмена и выдача.  
- **Ledger module** — баланс поинтов и операции пополнения/списания.  
- **Reviews module** — отзывы и рейтинги.  
- **Imports module** — импорты (пользователи/остатки/поинты), статусы и аудит импортов.  
- **Exports module** — запуск экспортных задач и статус экспорта.  
- **Audit module** — журнал аудита админских действий и ключевых операций.

**Инфраструктурные компоненты:**

- **Persistence Layer** — доступ к `PostgreSQL` (репозитории/ORM).  
- **Cache & Sessions** — сессии, кэш остатков, публикация задач в `Redis`.  
- **Media Gateway** — работа с `File Storage` (S3): загрузка и чтение медиа.  
- **Job Orchestrator** — публикация и оркестрация фоновых задач через Redis/cron (для `Export Worker`).  
- **Observability** — отправка ошибок и трассировок в `Sentry`.

Логика взаимодействий отражена следующим образом: `Web App` обращается к `HTTP API (routers)`, который маршрутизирует запросы в доменные модули. Доменные модули используют общие инфраструктурные компоненты (`Persistence Layer`, `Cache & Sessions`, `Media Gateway`) и фиксируют значимые события через `Audit module`. Экспортные операции запускаются через `Exports module`, который инициирует выполнение задач через `Job Orchestrator`.

![C4_Components_Backend](../assets/c4_components_backend/C4_Components_Backend.svg)

### Компоненты Web App

Диаграмма компонентов `Web App` показывает основные области интерфейса и общий клиент доступа к API:

- **Shell and Auth UI** — каркас приложения, навигация, авторизация и управление сессией.  
- **Catalog and Product UI** — каталог, поиск, фильтры, карточка товара и фото.  
- **Cart and Checkout UI** — корзина и оформление заказа.  
- **My Orders and Reviews UI** — история заказов, статусы и отзывы.  
- **Admin Users UI** — управление пользователями и ролями.  
- **Admin Catalog UI** — управление товарами, категориями и медиа.  
- **Admin Inventory UI** — просмотр и корректировка остатков, запуск импортов.  
- **Admin Orders UI** — очередь заказов, изменение статусов, отмена и выдача.  
- **Admin Imports and Exports UI** — запуск и мониторинг импортов и экспортов.  
- **Admin Audit UI** — просмотр журнала аудита действий администраторов.  
- **API Client** — единый HTTP-клиент для вызовов `Backend API` (общие и админские операции).

Все роли входят в систему через `Shell and Auth UI`, после чего получают доступ к соответствующим разделам (пользовательским или административным). Компоненты интерфейса используют общий `API Client` для вызовов `Backend API`. Ошибки фронтенда отправляются в `Sentry`, деплой приложения выполняется через `CI/CD Pipeline`.

![C4_Components_Frontend](../assets/c4_components_frontend/C4_Components_Frontend.svg)
