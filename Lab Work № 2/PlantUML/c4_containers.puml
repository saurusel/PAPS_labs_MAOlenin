@startuml C4_Containers
!includeurl https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

LAYOUT_LEFT_RIGHT()

Person(buyer, "Buyer", "Сотрудник компании, который тратит внутренние поинты на мерч")
Person(content_admin, "Content Admin", "Управляет каталогом товаров и медиа")
Person(fulfillment_admin, "Fulfillment Admin", "Обрабатывает и выдаёт заказы")
Person(combo_admin, "Combo Admin", "Совмещает права контент-админа и админа выдачи")
Person(super_admin, "Super Admin", "Управляет пользователями, ролями и системными настройками")
Person_Ext(bi_analyst, "BI Analyst", "Строит отчёты и дашборды по продажам мерча")

System_Boundary(merch_boundary, "Corporate Merch Store") {

    Container(customer_web, "Customer Web App", "React, TypeScript, PWA", "Интерфейс покупателя: каталог, корзина, мои заказы, отзывы")

    Container(admin_web, "Admin Web App", "React, TypeScript", "Админ-панель: пользователи, каталог, остатки, заказы, импорты/экспорт, аудит")

    Container(api_app, "Backend API", "FastAPI, Python", "HTTP API с бизнес-логикой, админкой и интеграциями")

    Container(export_worker, "Export Worker", "Python background jobs", "Фоновые задачи экспорта в Google Sheets и авто-закрытия заказов")

    ContainerDb(db, "Relational Database", "PostgreSQL", "Пользователи, роли, товары, остатки, заказы, леджер, отзывы, импорты, аудит")

    Container(redis, "Cache and Jobs", "Redis", "Кэш остатков, сессии и очередь фоновых задач")

    Container(file_storage, "File Storage", "S3-compatible storage + CDN", "Изображения товаров и статические файлы")
}

System_Ext(google_sheets, "Google Sheets", "Оперативный dump данных для аналитики")
System_Ext(bigquery, "Google BigQuery", "Корпоративное хранилище аналитических данных")
System_Ext(looker, "Looker Studio", "BI-панели и отчёты по мерчу")

System_Ext(sentry, "Sentry", "Мониторинг ошибок фронта и бэка")
System_Ext(ci_cd, "CI/CD Pipeline", "Автоматический деплой приложений из репозитория")
System_Ext(backup_storage, "Backup Storage", "Хранилище резервных копий БД")

Rel(buyer, customer_web, "Каталог, корзина, заказы, отзывы", "HTTPS")
Rel(content_admin, admin_web, "Каталог, остатки, медиа, импорты", "HTTPS")
Rel(fulfillment_admin, admin_web, "Очередь заказов и статусы выдачи", "HTTPS")
Rel(combo_admin, admin_web, "Комбо-админ: каталог и выдача", "HTTPS")
Rel(super_admin, admin_web, "Пользователи, роли, импорты/экспорт, аудит, настройки", "HTTPS")

Rel(customer_web, api_app, "REST/JSON: каталог, заказы, мой профиль", "HTTPS")
Rel(admin_web, api_app, "REST/JSON: админские операции", "HTTPS")

Rel(api_app, db, "Читает и записывает бизнес-данные", "SQL")
Rel(api_app, redis, "Кэш остатков, сессии, публикация задач", "Redis protocol")
Rel(api_app, file_storage, "Загружает и читает изображения товаров", "S3 API")
Rel(api_app, export_worker, "Публикует и оркестрирует фоновые задачи через Redis/cron", "async")

Rel(export_worker, db, "Читает изменения заказов, остатков, леджера и отзывов", "SQL")
Rel(export_worker, redis, "Получает задания экспорта и авто-закрытия", "Redis protocol")
Rel(export_worker, google_sheets, "Записывает строки в листы Orders/OrderItems/Stock/Ledger/Reviews", "Google Sheets API")

Rel(google_sheets, bigquery, "Использует dump как источник данных", "ETL / Connected Sheets")
Rel(bigquery, looker, "Источник данных для дашбордов", "SQL")
Rel(bi_analyst, looker, "Просматривает дашборды и строит отчёты", "Browser")

Rel(customer_web, sentry, "Отправляет фронтовые ошибки", "HTTPS")
Rel(admin_web, sentry, "Отправляет фронтовые ошибки", "HTTPS")
Rel(api_app, sentry, "Отправляет ошибки и трассировки", "HTTPS")
Rel(export_worker, sentry, "Отправляет ошибки фоновых задач", "HTTPS")

Rel(db, backup_storage, "Ежедневные резервные копии БД", "Backup job")

Rel(ci_cd, api_app, "Деплой новых версий Backend API", "Git / CI/CD")
Rel(ci_cd, customer_web, "Деплой Customer Web App", "Git / CI/CD")
Rel(ci_cd, admin_web, "Деплой Admin Web App", "Git / CI/CD")

SHOW_LEGEND()
@enduml
