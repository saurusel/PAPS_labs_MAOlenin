@startuml C4_Components_Backend
!includeurl https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml

LAYOUT_LEFT_RIGHT()

System_Boundary(merch_boundary, "Corporate Merch Store") {
    Container(api_app, "Backend API", "FastAPI, Python", "HTTP API с бизнес-логикой, админкой и интеграциями")
    ContainerDb(db, "Relational Database", "PostgreSQL", "Хранит пользователей, товары, заказы, леджер поинтов, отзывы, аудиты")
    Container(redis, "Cache and Jobs", "Redis", "Кэширование остатков, сессии и очередь фоновых задач")
    System_Ext(google_sheets, "Google Sheets", "Сервис для аналитики и отчётности")

    Container_Boundary(api_boundary, "Backend API components") {
        Component(auth_module, "Auth module", "FastAPI, Python", "Аутентификация, авторизация, управление пользователями и ролями")
        Component(catalog_module, "Catalog module", "FastAPI, Python", "Каталог товаров, категории, карточки товара и поиск")
        Component(inventory_module, "Inventory module", "FastAPI, Python", "Учёт остатков и предупреждение о низком остатке")
        Component(orders_module, "Orders module", "FastAPI, Python", "Создание заказов, статусы и процесс выдачи")
        Component(ledger_module, "Ledger module", "FastAPI, Python", "Учёт баланса поинтов и операций пополнения/списания")
        Component(reviews_module, "Reviews module", "FastAPI, Python", "Отзывы, рейтинги и модерация отзывов")
        Component(admin_module, "Admin module", "FastAPI, Python", "Админские API для пользователей, ролей, заказов и настроек")
        Component(imports_module, "Imports module", "FastAPI, Python", "Импорт пользователей, остатков и поинтов из CSV")
        Component(exports_module, "Exports module", "FastAPI, Python", "Экспорт данных в Google Sheets и ручной запуск экспорта")
        Component(audit_module, "Audit module", "FastAPI, Python", "Аудит действий администраторов и ключевых операций")
    }
}

Rel(auth_module, db, "CRUD пользователей, ролей, учёт аутентификации", "SQL")
Rel(catalog_module, db, "Читает и обновляет товары, категории и медиа", "SQL")
Rel(inventory_module, db, "Читает и обновляет остатки по SKU", "SQL")
Rel(orders_module, db, "Создаёт и обновляет заказы и позиции заказа", "SQL")
Rel(ledger_module, db, "Записывает движения по леджеру поинтов", "SQL")
Rel(reviews_module, db, "Читает и записывает отзывы и рейтинги", "SQL")
Rel(imports_module, db, "Записывает результаты импортов", "SQL")
Rel(exports_module, db, "Читает данные заказов, остатков, леджера и отзывов", "SQL")
Rel(audit_module, db, "Записывает аудит действий администраторов", "SQL")

Rel(orders_module, inventory_module, "Проверяет и списывает остатки при оформлении заказов")
Rel(orders_module, ledger_module, "Создаёт записи леджера при списании и возврате поинтов")
Rel(exports_module, google_sheets, "Создаёт строки в листах Orders, OrderItems, Stock, Ledger, Reviews", "Google Sheets API")
Rel(imports_module, redis, "Публикует задачи на обработку больших импортов", "Redis protocol")
Rel(exports_module, redis, "Получает задания на экспорт в фоне", "Redis protocol")

Rel(admin_module, auth_module, "Управляет пользователями и ролями через API")
Rel(admin_module, catalog_module, "Управляет каталогом и медиа")
Rel(admin_module, orders_module, "Управляет статусами и отменой заказов")
Rel(admin_module, imports_module, "Запускает импорты и смотрит статус")
Rel(admin_module, exports_module, "Запускает экспорты и смотрит статус")
Rel(admin_module, audit_module, "Просматривает аудит действий администраторов")

SHOW_LEGEND()
@enduml
